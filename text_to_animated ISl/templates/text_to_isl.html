<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text/Audio to ISL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    <header>
        <h1><a href="/" style="color:#bb86fc;text-decoration:none;">ISL Bridge</a></h1>
    </header>
    <div class="content">
        <div class="left">
            <div class="lang">English</div>
            <div class="input-wrapper">
                <textarea id="textInput" placeholder="Type or speak..."></textarea>
                <span class="mic" id="micIcon">ðŸŽ¤</span>
                <span class="count" id="charCount">0 / 500</span>
            </div>
        </div>
        <div class="right">
            <div class="lang">Indian Sign Language</div>
            <div class="output">
                <video id="islVideo" muted playsinline></video>
                <button id="repeatBtn" style="display:none; position:absolute; bottom:20px; right:20px; background:#bb86fc; color:black; border:none; padding:12px 20px; border-radius:30px; cursor:pointer; font-weight:bold; box-shadow:0 0 20px #bb86fc;">Repeat Animation</button>
            </div>
        </div>
    </div>
    <div class="options">
        <div class="speed">
            Speed: <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
            <span id="speedValue">1x</span>
        </div>
        <a id="downloadBtn" href="#" download>Download</a>
    </div>

    <script>
        const video = document.getElementById('islVideo');
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const downloadBtn = document.getElementById('downloadBtn');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const micIcon = document.getElementById('micIcon');
        const repeatBtn = document.getElementById('repeatBtn');
        let timer;
        let mediaRecorder;
        let audioChunks = [];
        let translated = false;

        textInput.addEventListener('input', () => {
            charCount.textContent = `${textInput.value.length} / 500`;
            clearTimeout(timer);
            timer = setTimeout(translate, 1000);
        });

        async function translate() {
            const text = textInput.value.trim();
            if (!text) return;
            const res = await fetch('/process_text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text})
            });
            const data = await res.json();
            if (data.url) {
                video.src = data.url;
                video.load();
                video.play();
                downloadBtn.href = data.url;
                downloadBtn.textContent = 'Download Ready';
                downloadBtn.classList.add('ready');
                repeatBtn.style.display = 'block';
                translated = true;
                video.onended = () => video.pause();
            }
        }

        speedSlider.addEventListener('input', () => {
            video.playbackRate = parseFloat(speedSlider.value);
            speedValue.textContent = speedSlider.value + 'x';
        });

        repeatBtn.addEventListener('click', () => {
            video.currentTime = 0;
            video.play();
        });

        micIcon.addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, {type: 'audio/wav'});
                    const form = new FormData();
                    form.append('audio', blob);
                    const res = await fetch('/process_audio', {method: 'POST', body: form});
                    const data = await res.json();
                    if (data.url) {
                        video.src = data.url;
                        video.load();
                        video.play();
                        downloadBtn.href = data.url;
                        downloadBtn.textContent = 'Download Ready';
                        downloadBtn.classList.add('ready');
                        repeatBtn.style.display = 'block';
                        translated = true;
                        video.onended = () => video.pause();
                    }
                };
                mediaRecorder.start();
                micIcon.textContent = 'ðŸ”´';
            } else {
                mediaRecorder.stop();
                micIcon.textContent = 'ðŸŽ¤';
            }
        });
    </script>
    <script>
        const canvas = document.getElementById('bgCanvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = innerWidth; canvas.height = innerHeight;
            const nodes = Array.from({length: 100}, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 0.7,
                vy: (Math.random() - 0.5) * 0.7
            }));
            function animate() {
                ctx.fillStyle = 'rgba(0,0,0,0.05)';
                ctx.fillRect(0,0,canvas.width,canvas.height);
                nodes.forEach(n => {
                    n.x += n.vx; n.y += n.vy;
                    if (n.x < 0 || n.x > canvas.width) n.vx *= -1;
                    if (n.y < 0 || n.y > canvas.height) n.vy *= -1;
                    ctx.beginPath();
                    ctx.arc(n.x, n.y, 3, 0, Math.PI*2);
                    ctx.fillStyle = '#bb86fc';
                    ctx.fill();
                });
                requestAnimationFrame(animate);
            }
            animate();
            window.onresize = () => { canvas.width = innerWidth; canvas.height = innerHeight; };
        }
    </script>
</body>
</html>